local a=require("cc.expect")local b=require("am.core")local c=require("am.ui.elements.frame")local d=require("am.ui.elements.button")local e=require("am.ui.anchor")local f=require("am.ui.helpers")local g=require("am.ui.event")local h=require("am.ui.const")local i=c.Bound:extend("am.ui.BoundTabbedFrame")function i:createTab(j)return self.obj:createTab(j)end;function i:getIndex(k)return self.obj:getIndex(k)end;function i:setLabel(k,l)return self.obj:setLabel(self.output,k,l)end;function i:getTab(k)return self.obj:getTab(self.output,k)end;function i:getActive()return self.obj:getActive(self.output)end;function i:setActive(k)self.obj:setActive(self.output,k)end;function i:renderTabs()self.obj:renderTabs(self.output)end;local m=c:extend("am.ui.Popup")function m:init(n,o)o=o or{}a.expect(1,n,"table")a.field(o,"primaryTabId","string","nil")a.field(o,"showTabs","boolean","nil")a.field(o,"tabBackgroundColor","number","nil")a.field(o,"activeTabFillColor","number","nil")a.field(o,"activeTabTextColor","number","nil")a.field(o,"tabFillColor","number","nil")a.field(o,"tabTextColor","number","nil")m.super.init(self,n,o)if o.primaryTabId==nil then o.primaryTabId="main"end;if o.showTabs==nil then o.showTabs=false end;if o.activeTabFillColor==nil then o.activeTabFillColor=o.tabFillColor end;if o.activeTabTextColor==nil then o.activeTabTextColor=o.tabTextColor end;self.i=nil;self.tabs={}self.tabIndexIdMap={}self.tabIdMap={}self.tabLabelMap={}self.tabIndexLabelMap={}self.tabBackgroundColor=o.tabBackgroundColor;self.tabFillColor=o.tabFillColor;self.tabTextColor=o.tabTextColor;self.activeTabFillColor=o.activeTabFillColor;self.activeTabTextColor=o.activeTabTextColor;self.labelFrame=nil;if o.showTabs then self.labelFrame=c(e.TopLeft(),{id=self.id..".labelFrame",height=1,border=0,fillHorizontal=true,fillColor=o.tabBackgroundColor})end;self:createTab(o.primaryTabId)self:setActive(nil,1)return self end;function m:createTab(j,p)if self.tabIdMap[j]~=nil then error(string.format("Tab with id %s already exists",j))return end;local n=e.Anchor(1,1)if self.labelFrame~=nil then n.y=2 end;local q=#self.tabs+1;local r=string.format("%s.%s",self.id,j)local s=c(n,{id=r,width=self.width,height=self.height,fillHorizontal=self.fillHorizontal,fillVertical=self.fillVertical,padLeft=self.padLeft,padRight=self.padRight,padTop=self.padTop,padBottom=self.padBottom,backgroundColor=self.backgroundColor,borderColor=self.borderColor,fillColor=self.fillColor,textColor=self.textColor,border=self.border,scrollBar=self.scrollBar,scrollBarTrackColor=self.scrollBarTrackColor,scrollBarColor=self.scrollBarColor,scrollBarButtonColor=self.scrollBarButtonColor,scrollBarTextColor=self.scrollBarTextColor,scrollBarDisabledColor=self.scrollBarDisabledColor})if self.labelFrame~=nil then self.labelFrame:add(d(e.Anchor(1,1),{id=r.."Label"}))end;s:setVisible(false)self.tabs[q]=s;self.tabIdMap[j]=q;self.tabIndexIdMap[q]=j;if p~=nil then local t=g.TabCreatedEvent(p,self.id,j)os.queueEvent(t.name,t)end;return s end;function m:getIndex(k)a.expect(1,k,"number","string")local q=nil;if type(k)=="number"then a.range(q,1,#self.tabs)q=k else q=self.tabIdMap[k]end;return q end;function m:removeTab(k,p)a.expect(1,k,"number","string")if#self.tabs==1 then error("Cannot remove last tab")end;local u=self:getIndex(k)local v=self.tabIndexIdMap;local w=self.tabIndexLabelMap;local r=v[u]self.tabIndexIdMap={}self.tabIdMap={}self.tabLabelMap={}self.tabIndexLabelMap={}for q,j in ipairs(v)do if q~=u then local l=w[q]if q>u then q=q-1 end;self.tabIndexIdMap[q]=j;self.tabIdMap[j]=q;self.tabLabelMap[l]=q;self.tabIndexLabelMap[j]=l end end;table.remove(self.tabs,u)if p~=nil then local t=g.TabRemovedEvent(p,self.id,r)os.queueEvent(t.name,t)end;if u>#self.tabs then if p~=nil then self:setActive(p,#self.tabs)else self.active=#self.tabs end end end;function m:setLabel(p,k,l)a.expect(1,k,"number","string")a.expect(2,l,"string")local q=self:getIndex(k)if q==nil then error("Could not find tab")end;if self.tabLabelMap[l]~=nil then error(string.format("Label %s already exists",l))end;local x=self.tabIndexLabelMap[q]if x~=nil then self.tabLabelMap[x]=nil end;self.tabLabelMap[l]=q;self.tabIndexLabelMap[q]=l;local t=g.TabLabelUpdatedEvent(p,self.id,self.tabIndexIdMap[q],x,l)os.queueEvent(t.name,t)end;function m:getTab(p,k)a.expect(1,k,"number","string")local q=self:getIndex(k)local s=nil;if q~=nil then s=self.tabs[q]end;if s==nil then error("Could not find tab")end;return s:bind(self:makeScreen(p))end;function m:getActive(p)return self:getTab(p,self.active)end;function m:setActive(p,k)a.expect(1,k,"number","string")local q=self:getIndex(k)for u,s in ipairs(self.tabs)do if u==q then s:setVisible(true)if s.scrollBar then s.currentScroll=0 end else s:setVisible(false)end end;if p~=nil then local t=g.TabChangedEvent(p,self.id,self.active,q)os.queueEvent(t.name,t)end;self.active=q end;function m:setVisible(y)a.expect(1,y,"boolean")if y then self:setActive(nil,self.active)else for z,s in ipairs(self.tabs)do s:setVisible(false)end end;self.visible=y end;function m:renderTabs(p)if not self.visible then return end;if self.labelFrame==nil then return end;local A=1;local B=f.getColor(self.tabFillColor,self.fillColor,p.getBackgroundColor())local C=f.getColor(self.tabTextColor,self.textColor,p.getTextColor())for q,j in ipairs(self.tabIndexIdMap)do local D=self.tabIndexLabelMap[q]or j;local E=string.format("%s.%sLabel",self.id,j)local l=self.labelFrame:get(E,p)l.obj.label.label=D;l.obj.anchor.x=A;if q==self.active then l.obj.fillColor=f.getColor(self.activeTabFillColor,B)l.obj.textColor=f.getColor(self.activeTabTextColor,C)else l.obj.fillColor=B;l.obj.textColor=C end;A=#D+2 end;local F=self:makeScreen(p)self.labelFrame:render(F)end;function m:render(p)if not self.visible then return end;self:renderTabs(p)local s=self:getActive(p)s:render()end;function m:get(j,p)a.expect(1,j,"string")a.expect(2,p,"table","nil")if p~=nil then f.requireOutput(p)end;if j==self.id then return self:bind(p)end;for z,s in ipairs(self.tabs)do if j==s.id then return self:bind(p)end;local G=s:get(j,p)if G~=nil then return G end end;return nil end;function m:makeScreen(p,H,I,J,K)local s=self:getActive(p)return s:makeScreen(H,I,J,K)end;function m:scroll(p,L)local s=self:getActive(p)return s:scroll(L)end;function m:within(p,M,N)local s=self:getActive(p)return s:within(M,N)end;function m:handle(p,t,...)local t,O=b.cleanEventArgs(t,...)if t==g.c.Event.tab_created or t==g.c.Event.tab_removed or t==g.c.Event.tab_label_update then self:renderTabs(p)elseif t==h.e.Events.tab_change then self:setActive(nil,O[1].newIndex)self:render(p)return true end;for z,s in ipairs(self.tabs)do if s:handle(p,t,table.unpack(O))then return true end end;return false end;function m:bind(p)return i(p,self)end;return m
